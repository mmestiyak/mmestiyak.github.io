{% extends "base.html" %}

{% block title %}Logs — {{ config.title }}{% if paginator and paginator.current_index > 1 %} — Page {{ paginator.current_index }}{% endif %}{% endblock title %}
{% block description %}All logs by Meer Estiyak on software development, programming, and more.{% endblock description %}
{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8">

    <!-- Simple Search Only -->
    <div class="mb-8 sm:mb-10">
        <div class="relative max-w-2xl mb-6 sm:mb-8">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Search posts..." 
                class="w-full px-4 py-3 pl-10 pr-10 text-base text-gray-900 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 transition-all duration-200 placeholder:text-gray-400"
                aria-label="Search through all blog posts"
                autocomplete="off"
                spellcheck="false"
            >
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <button 
                id="clear-search" 
                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors hidden"
                aria-label="Clear search"
                onclick="window.simpleSearch.clearSearch()"
            >
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
            <!-- Results Summary -->
            <div id="results-summary" class="mb-4 sm:mb-6 hidden">
                <div class="text-sm text-gray-600">
                    <span id="results-count">0</span>
            </div>
        </div>
    </div>

    <div id="all-posts" class="space-y-3 sm:space-y-4">
        {% for page in paginator.pages %}
        <article class="py-4 sm:py-5 border-b border-gray-200 last:border-0">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                    <h2 class="text-base sm:text-lg font-medium text-gray-900 mb-1">
                        <a href="{{ page.permalink }}" class="hover:text-gray-600 transition-colors">{{ page.title }}</a>
                    </h2>
                    <div class="flex items-center gap-2 text-xs sm:text-sm text-gray-500">
                        <time datetime="{{ page.date }}">{{ page.date | date(format="%b %d, %Y") }}</time>
                        {% if page.reading_time %}
                        <span>•</span>
                        <span>{{ page.reading_time }} min</span>
                        {% endif %}
                    </div>
                </div>
                {% if page.taxonomies.topics %}
                <div class="flex gap-1 flex-shrink-0 self-start">
                    {% for topic in page.taxonomies.topics %}
                    <a href="{{ get_taxonomy_url(kind="topics", name=topic) }}" class="px-1.5 py-0.5 sm:px-2 sm:py-1 text-xs text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors whitespace-nowrap">
                        {{ topic }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if paginator.number_pagers > 1 %}
    <nav id="pagination-nav" class="mt-8 sm:mt-12 flex justify-center sm:justify-start">
        <div class="flex items-center space-x-2">
            {% if paginator.previous %}
            <a href="{{ paginator.previous }}" class="px-3 py-2 text-sm text-gray-500 hover:text-brand transition-colors hover:bg-brand/5 rounded-md">← Previous</a>
            {% endif %}
            
            <span class="px-3 py-2 text-sm text-gray-400">
                Page {{ paginator.current_index }} of {{ paginator.number_pagers }}
            </span>
            
            {% if paginator.next %}
            <a href="{{ paginator.next }}" class="px-3 py-2 text-sm text-gray-500 hover:text-brand transition-colors hover:bg-brand/5 rounded-md">Next →</a>
            {% endif %}
        </div>
    </nav>
    {% endif %}
</div>

<!-- Simple Search System -->
<script>
// Simple search-only system
class SimpleSearch {
    constructor() {
        this.allPosts = [];
        this.filteredPosts = [];
        this.searchQuery = '';
        this.currentPage = 1;
        this.postsPerPage = {{ section.paginate_by | default(value=5) }};
        
        this.init();
    }
    
    init() {
        this.loadPosts();
        this.setupEventListeners();
        this.applySearch();
    }
    
    loadPosts() {
        // Load ALL posts data from the entire site (Zola static generation)
        this.allPosts = [
        {% set all_posts = get_section(path="logs/_index.md") %}
        {% for page in all_posts.pages %}
        {
            id: '{{ page.slug }}',
            title: {{ page.title | json_encode | safe }},
            description: {{ page.description | default(value="") | json_encode | safe }},
            date: '{{ page.date }}',
            url: '{{ page.permalink }}',
            topics: {{ page.taxonomies.topics | default(value=[]) | json_encode | safe }},
            tags: {{ page.taxonomies.tags | default(value=[]) | json_encode | safe }},
            readingTime: '{{ page.reading_time | default(value="") }}',
            topicUrls: {
                {% for topic in page.taxonomies.topics | default(value=[]) %}
                {{ topic | json_encode | safe }}: {{ get_taxonomy_url(kind="topics", name=topic) | json_encode | safe }}{% if not loop.last %},{% endif %}
                {% endfor %}
            },
            // Pre-computed search text for better performance
            searchText: ({{ page.title | json_encode | safe }} + ' ' + {{ page.description | default(value="") | json_encode | safe }} + ' ' + {{ page.taxonomies.topics | default(value=[]) | join(sep=" ") | json_encode | safe }} + ' ' + {{ page.taxonomies.tags | default(value=[]) | join(sep=" ") | json_encode | safe }}).toLowerCase()
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
        this.filteredPosts = [...this.allPosts];
        
        // Sort by date (newest first)
        this.allPosts.sort((a, b) => new Date(b.date) - new Date(a.date));
        this.filteredPosts.sort((a, b) => new Date(b.date) - new Date(a.date));
    }
    
    setupEventListeners() {
        const searchInput = document.getElementById('search-input');
        if (!searchInput) {
            console.error('Search input element not found');
            return;
        }
        
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.searchQuery = e.target.value.trim().toLowerCase();
                this.toggleClearButton();
                this.applySearch();
            }, 150);
        });
    }
    
    applySearch() {
        if (!this.searchQuery) {
            // No search query, show all posts
            this.filteredPosts = [...this.allPosts];
        } else {
            // Filter posts based on search query
            this.filteredPosts = this.allPosts.filter(post => {
                return post.searchText.includes(this.searchQuery);
            });
        }
        
        this.currentPage = 1; // Reset to first page when search changes
        this.updateDisplay();
        this.updateResultsSummary();
        this.updatePagination();
    }
    
    updateDisplay() {
        const container = document.getElementById('all-posts');
        const resultsSummary = document.getElementById('results-summary');
        
        if (!container) {
            console.error('Posts container not found');
            return;
        }
        
        if (this.filteredPosts.length === 0) {
            let message = '';
            if (this.searchQuery) {
                message = `No logs found for "${this.searchQuery}". Try different keywords or check your spelling.`;
            } else {
                message = 'No logs available.';
            }
            container.innerHTML = `<div class="text-center py-12 text-gray-500">${message}</div>`;
            if (resultsSummary) {
                resultsSummary.classList.remove('hidden');
            }
            this.hidePagination();
            return;
        }
        
        // Calculate pagination
        const startIndex = (this.currentPage - 1) * this.postsPerPage;
        const endIndex = startIndex + this.postsPerPage;
        const postsToShow = this.filteredPosts.slice(startIndex, endIndex);
        
        container.innerHTML = postsToShow.map(post => this.renderPost(post)).join('');
        if (resultsSummary) {
            resultsSummary.classList.remove('hidden');
        }
        this.updatePagination();
    }
    
    renderPost(post) {
        // Safe array handling with fallbacks
        const topics = post.topics || [];
        const tags = post.tags || [];
        const topicUrls = post.topicUrls || {};
        const tagUrls = post.tagUrls || {};
        
        const topicsHtml = topics.length > 0 ? topics.map(topic => 
            `<a href="${topicUrls[topic] || '#'}" class="px-1.5 py-0.5 sm:px-2 sm:py-1 text-xs text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors whitespace-nowrap flex-shrink-0">${topic}</a>`
        ).join('') : '';
        
        const readingTime = post.readingTime ? 
            `<span>•</span><span>${post.readingTime} min read</span>` : '';
        
        // Safe date parsing
        let formattedDate = 'No date';
        try {
            if (post.date) {
                const dateObj = new Date(post.date);
                if (!isNaN(dateObj.getTime())) {
                    formattedDate = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                }
            }
        } catch (error) {
            console.warn('Date parsing error:', error);
        }
        
        return `
            <article class="py-4 sm:py-5 border-b border-gray-200 last:border-0">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <h2 class="text-base sm:text-lg font-medium text-gray-900 mb-1">
                            <a href="${post.url}" class="hover:text-gray-600 transition-colors">${post.title}</a>
                            </h2>
                        <div class="flex items-center gap-2 text-xs sm:text-sm text-gray-500">
                            <time datetime="${post.date || ''}">${formattedDate}</time>
                            ${readingTime}
                        </div>
                    </div>
                    ${topics.length > 0 ? `
                    <div class="flex gap-1 flex-shrink-0 self-start">
                        ${topicsHtml}
                    </div>
                    ` : ''}
                </div>
            </article>
        `;
    }
    
    clearSearch() {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.value = '';
            this.searchQuery = '';
            this.applySearch();
        }
    }
    
    updateResultsSummary() {
        const totalPosts = this.filteredPosts.length;
        
        const resultsCount = document.getElementById('results-count');
        if (resultsCount) {
            let resultText = '';
            
            if (totalPosts === 0) {
                resultText = 'No logs found';
            } else if (totalPosts === 1) {
                resultText = '1 log found';
            } else if (totalPosts <= 50) {
                resultText = `${totalPosts} logs found`;
            } else {
                // Too many results - suggest refining search
                resultText = `${totalPosts} logs found (try refining your search)`;
            }
            
            resultsCount.textContent = resultText;
        }
        
        // Show/hide results summary
        const resultsSummary = document.getElementById('results-summary');
        if (resultsSummary) {
            resultsSummary.classList.remove('hidden');
        }
    }
    
    updatePagination() {
        const totalPages = Math.ceil(this.filteredPosts.length / this.postsPerPage);
        const paginationContainer = document.getElementById('pagination-nav');
        
        if (totalPages <= 1) {
            this.hidePagination();
            return;
        }
        
        paginationContainer.classList.remove('hidden');
        
        let paginationHTML = '<div class="flex items-center justify-center gap-1">';
        
        // Previous button
        if (this.currentPage > 1) {
            paginationHTML += `<button onclick="simpleSearch.goToPage(${this.currentPage - 1})" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">←</button>`;
        }
        
        // Page numbers - show all pages if 5 or fewer, otherwise show smart pagination
        if (totalPages <= 5) {
            // Show all pages
            for (let i = 1; i <= totalPages; i++) {
                if (i === this.currentPage) {
                    paginationHTML += `<span class="px-3 py-2 text-sm bg-gray-900 text-white rounded-md">${i}</span>`;
                } else {
                    paginationHTML += `<button onclick="simpleSearch.goToPage(${i})" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">${i}</button>`;
                }
            }
        } else {
            // Smart pagination for many pages
            if (this.currentPage <= 3) {
                // Show first 4 pages + ... + last page
                for (let i = 1; i <= 4; i++) {
                    if (i === this.currentPage) {
                        paginationHTML += `<span class="px-3 py-2 text-sm bg-gray-900 text-white rounded-md">${i}</span>`;
                    } else {
                        paginationHTML += `<button onclick="simpleSearch.goToPage(${i})" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">${i}</button>`;
                    }
                }
                paginationHTML += `<span class="px-2 py-2 text-sm text-gray-400">...</span>`;
                paginationHTML += `<button onclick="simpleSearch.goToPage(${totalPages})" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">${totalPages}</button>`;
            } else if (this.currentPage >= totalPages - 2) {
                // Show first page + ... + last 4 pages
                paginationHTML += `<button onclick="simpleSearch.goToPage(1)" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">1</button>`;
                paginationHTML += `<span class="px-2 py-2 text-sm text-gray-400">...</span>`;
                for (let i = totalPages - 3; i <= totalPages; i++) {
                    if (i === this.currentPage) {
                        paginationHTML += `<span class="px-3 py-2 text-sm bg-gray-900 text-white rounded-md">${i}</span>`;
                    } else {
                        paginationHTML += `<button onclick="simpleSearch.goToPage(${i})" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">${i}</button>`;
                    }
                }
            } else {
                // Show first page + ... + current-1, current, current+1 + ... + last page
                paginationHTML += `<button onclick="simpleSearch.goToPage(1)" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">1</button>`;
                paginationHTML += `<span class="px-2 py-2 text-sm text-gray-400">...</span>`;
                
                for (let i = this.currentPage - 1; i <= this.currentPage + 1; i++) {
                    if (i === this.currentPage) {
                        paginationHTML += `<span class="px-3 py-2 text-sm bg-gray-900 text-white rounded-md">${i}</span>`;
                    } else {
                        paginationHTML += `<button onclick="simpleSearch.goToPage(${i})" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">${i}</button>`;
                    }
                }
                
                paginationHTML += `<span class="px-2 py-2 text-sm text-gray-400">...</span>`;
                paginationHTML += `<button onclick="simpleSearch.goToPage(${totalPages})" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">${totalPages}</button>`;
            }
        }
        
        // Next button
        if (this.currentPage < totalPages) {
            paginationHTML += `<button onclick="simpleSearch.goToPage(${this.currentPage + 1})" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">→</button>`;
        }
        
        paginationHTML += '</div>';
        
        paginationContainer.innerHTML = paginationHTML;
    }
    
    hidePagination() {
        const paginationContainer = document.getElementById('pagination-nav');
        paginationContainer.classList.add('hidden');
    }
    
    goToPage(page) {
        const totalPages = Math.ceil(this.filteredPosts.length / this.postsPerPage);
        if (page >= 1 && page <= totalPages) {
            this.currentPage = page;
            this.updateDisplay();
        }
    }
    
    toggleClearButton() {
        const clearButton = document.getElementById('clear-search');
        const searchInput = document.getElementById('search-input');
        
        if (clearButton && searchInput) {
            if (searchInput.value.trim().length > 0) {
                clearButton.classList.remove('hidden');
            } else {
                clearButton.classList.add('hidden');
            }
        }
    }
    
    
}

// Initialize the simple search system
window.simpleSearch = new SimpleSearch();
    
</script>
{% endblock content %}